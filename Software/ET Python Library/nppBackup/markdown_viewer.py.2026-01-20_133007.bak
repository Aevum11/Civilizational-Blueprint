import sys
import os
import json
import subprocess

# --- Auto-Install Dependencies Logic ---
try:
    from PyQt6.QtWidgets import (QApplication, QMainWindow, QFileDialog, 
                                 QVBoxLayout, QWidget, QTabWidget, QMessageBox)
    from PyQt6.QtWebEngineWidgets import QWebEngineView
    from PyQt6.QtCore import QUrl, Qt, QEvent
    from PyQt6.QtGui import QAction, QDragEnterEvent, QDropEvent, QIcon, QShortcut, QKeySequence
    import markdown
    from pygments.formatters import HtmlFormatter
except ImportError:
    # If imports fail, launch a temporary Tkinter window to show installation progress
    import tkinter as tk
    from tkinter import messagebox
    
    root = tk.Tk()
    root.title("Setup")
    
    width, height = 400, 120
    x = (root.winfo_screenwidth() // 2) - (width // 2)
    y = (root.winfo_screenheight() // 2) - (height // 2)
    root.geometry(f"{width}x{height}+{x}+{y}")
    
    tk.Label(root, text="First Run: Installing dependencies...", font=("Segoe UI", 10, "bold")).pack(pady=(20, 5))
    tk.Label(root, text="(PyQt6, PyQt6-WebEngine, Markdown, Pygments)\nThis may take a minute...", font=("Segoe UI", 8)).pack(pady=5)
    
    root.update()

    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "PyQt6", "PyQt6-WebEngine", "markdown", "pygments"])
        root.destroy()
        os.execv(sys.executable, [sys.executable] + sys.argv)
    except Exception as e:
        messagebox.showerror("Installation Failed", f"Error: {e}")
        sys.exit(1)

# --- Configuration & Styling ---
# Defines variables for both Light and Dark modes
BASE_CSS = """
<style>
    :root {
        /* Light Mode (Default) */
        --bg-color: #ffffff;
        --text-color: #24292f;
        --link-color: #0969da;
        --code-bg: #f6f8fa;
        --code-text: #24292f;
        --border-color: #d0d7de;
        --quote-color: #57606a;
        --quote-border: #d0d7de;
        --table-header-bg: #f6f8fa;
        --table-row-even: #ffffff;
        --table-row-hover: #f6f8fa;
    }

    body.dark-mode {
        /* Dark Mode Overrides */
        --bg-color: #0d1117;
        --text-color: #c9d1d9;
        --link-color: #58a6ff;
        --code-bg: #161b22;
        --code-text: #c9d1d9;
        --border-color: #30363d;
        --quote-color: #8b949e;
        --quote-border: #30363d;
        --table-header-bg: #161b22;
        --table-row-even: #0d1117;
        --table-row-hover: #161b22;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background-color: var(--bg-color);
        margin: 0;
        padding: 32px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        transition: background-color 0.3s, color 0.3s;
    }

    /* Headers */
    h1, h2, h3, h4, h5, h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
        color: var(--text-color);
    }
    h1 { font-size: 2em; padding-bottom: 0.3em; border-bottom: 1px solid var(--border-color); }
    h2 { font-size: 1.5em; padding-bottom: 0.3em; border-bottom: 1px solid var(--border-color); }

    /* Links */
    a { color: var(--link-color); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Quotes */
    blockquote {
        margin: 0 0 16px;
        padding: 0 1em;
        color: var(--quote-color);
        border-left: 0.25em solid var(--quote-border);
    }

    /* Code Blocks */
    pre {
        background-color: var(--code-bg);
        border-radius: 6px;
        padding: 16px;
        overflow: auto;
        line-height: 1.45;
        border: 1px solid var(--border-color);
    }
    
    /* Inline Code - The "Red Square" Fix: Now neutral colored */
    code {
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        padding: 0.2em 0.4em;
        margin: 0;
        font-size: 85%;
        background-color: var(--code-bg);
        color: var(--code-text); /* Uses theme color instead of red */
        border-radius: 6px;
    }
    
    pre code {
        padding: 0;
        background-color: transparent;
        font-size: 100%;
        color: inherit;
    }

    /* Tables */
    table {
        border-spacing: 0;
        border-collapse: collapse;
        display: block;
        width: 100%;
        width: max-content;
        max-width: 100%;
        overflow: auto;
        margin-bottom: 16px;
    }
    tr { background-color: var(--table-row-even); border-top: 1px solid var(--border-color); }
    tr:nth-child(2n) { background-color: var(--table-header-bg); }
    tr:hover { background-color: var(--table-row-hover); }
    th, td {
        padding: 6px 13px;
        border: 1px solid var(--border-color);
    }
    th { font-weight: 600; background-color: var(--table-header-bg); }

    /* Images */
    img {
        max-width: 100%;
        box-sizing: content-box;
        background-color: var(--bg-color);
    }
    
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: var(--border-color);
        border: 0;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 12px; height: 12px; }
    ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 6px; border: 3px solid var(--bg-color); }
    ::-webkit-scrollbar-track { background-color: var(--bg-color); }
</style>
"""

class DropFriendlyWebView(QWebEngineView):
    """
    A custom WebEngineView that intentionally ignores drag events.
    This forces the drag event to bubble up to the parent (MainWindow),
    which handles the actual file loading.
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        # Crucial: This tells Qt this widget does NOT want drops, 
        # so the parent widget gets a chance to handle them.
        self.setAcceptDrops(False) 

class MarkdownViewer(QMainWindow):
    def __init__(self):
        super().__init__()

        self.setWindowTitle("Markdown Viewer Pro")
        self.resize(1100, 800)
        self.is_dark_mode = False

        # --- Enable Drag and Drop on the Main Window ---
        self.setAcceptDrops(True)

        # --- Setup Tabs ---
        self.tabs = QTabWidget()
        self.tabs.setTabsClosable(True)
        self.tabs.tabCloseRequested.connect(self.close_tab)
        self.tabs.setDocumentMode(True) # Makes it look more like a browser
        self.setCentralWidget(self.tabs)

        # --- Setup Menus ---
        self.create_menu()

        # --- Load Initial Tab ---
        self.load_markdown(self.get_welcome_markdown(), title="Welcome")

    def create_menu(self):
        menubar = self.menuBar()
        
        # File Menu
        file_menu = menubar.addMenu("&File")
        
        open_action = QAction("&Open File...", self)
        open_action.setShortcut("Ctrl+O")
        open_action.triggered.connect(self.open_file_dialog)
        file_menu.addAction(open_action)

        close_tab_action = QAction("Close &Tab", self)
        close_tab_action.setShortcut("Ctrl+W")
        close_tab_action.triggered.connect(self.close_current_tab)
        file_menu.addAction(close_tab_action)

        file_menu.addSeparator()

        exit_action = QAction("E&xit", self)
        exit_action.setShortcut("Ctrl+Q")
        exit_action.triggered.connect(self.close)
        file_menu.addAction(exit_action)

        # View Menu
        view_menu = menubar.addMenu("&View")
        
        self.dark_mode_action = QAction("Dark Mode", self, checkable=True)
        self.dark_mode_action.setShortcut("Ctrl+D")
        self.dark_mode_action.triggered.connect(self.toggle_dark_mode)
        view_menu.addAction(self.dark_mode_action)

    # --- Drag and Drop Logic ---
    def dragEnterEvent(self, event: QDragEnterEvent):
        if event.mimeData().hasUrls():
            event.acceptProposedAction()
        else:
            event.ignore()

    def dropEvent(self, event: QDropEvent):
        files = [u.toLocalFile() for u in event.mimeData().urls()]
        for file_path in files:
            if os.path.isfile(file_path):
                self.load_file_from_path(file_path)

    # --- File Handling ---
    def open_file_dialog(self):
        file_name, _ = QFileDialog.getOpenFileName(
            self, "Open Markdown File", "", "Markdown Files (*.md);;Text Files (*.txt);;All Files (*)"
        )
        if file_name:
            self.load_file_from_path(file_name)

    def load_file_from_path(self, file_path):
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            self.load_markdown(content, base_path=os.path.dirname(file_path), title=os.path.basename(file_path))
        except Exception as e:
            print(f"Error reading file: {e}")

    # --- Tab Management ---
    def close_tab(self, index):
        if self.tabs.count() > 1:
            self.tabs.removeTab(index)
        else:
            # If closing the last tab, maybe just reset it or close app?
            # Let's just clear it to welcome screen
            self.tabs.removeTab(index)
            self.load_markdown(self.get_welcome_markdown(), title="Welcome")

    def close_current_tab(self):
        self.close_tab(self.tabs.currentIndex())

    # --- Rendering Logic ---
    def load_markdown(self, markdown_text, base_path=None, title="Untitled"):
        # 1. Convert Markdown to HTML
        html_content = markdown.markdown(
            markdown_text, 
            extensions=['fenced_code', 'tables', 'codehilite', 'nl2br', 'sane_lists']
        )

        # 2. Get Syntax Highlighting CSS
        formatter = HtmlFormatter(style='friendly') # 'friendly' looks good in light mode
        pygments_css = formatter.get_style_defs('.codehilite')
        
        # 3. Construct HTML
        base_tag = f'<base href="file:///{base_path.replace(os.sep, "/")}/">' if base_path else ""
        
        # Determine initial theme class
        body_class = "dark-mode" if self.is_dark_mode else ""

        full_html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            {base_tag}
            {BASE_CSS}
            <style>
                {pygments_css}
                /* Ensure pygments bg allows transparency for our theme vars to work */
                .codehilite {{ background: transparent !important; }}
                .codehilite pre {{ background: transparent !important; }}
            </style>
        </head>
        <body class="{body_class}">
            {html_content}
        </body>
        </html>
        """

        # 4. Create New Tab
        view = DropFriendlyWebView()
        view.setContextMenuPolicy(Qt.ContextMenuPolicy.NoContextMenu)
        view.setHtml(full_html)
        
        # Add to tabs and set as current
        index = self.tabs.addTab(view, title)
        self.tabs.setCurrentIndex(index)

    # --- Dark Mode Logic ---
    def toggle_dark_mode(self):
        self.is_dark_mode = self.dark_mode_action.isChecked()
        
        # Toggle class on ALL open tabs via JavaScript
        js_code = "document.body.classList.toggle('dark-mode');"
        for i in range(self.tabs.count()):
            view = self.tabs.widget(i)
            if isinstance(view, QWebEngineView):
                view.page().runJavaScript(js_code)

    def get_welcome_markdown(self):
        return """
# Markdown Viewer Pro

**Features Enabled:**
1.  [x] **Tabs**: Open multiple files at once.
2.  [x] **Drag & Drop**: Drag files onto this window.
3.  [x] **Dark Mode**: Toggle via `View > Dark Mode` (Ctrl+D).
4.  [x] **Clean Code**: No red squares!

## Code Example
```python
def hello():
    print("This code block matches the theme!")
```

## Inline Code
You can now use `inline code` without it looking like an error.

> "Simplicity is the ultimate sophistication." 
> â€” Leonardo da Vinci
"""

if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyle("Fusion") 
    
    viewer = MarkdownViewer()
    viewer.show()
    
    sys.exit(app.exec())