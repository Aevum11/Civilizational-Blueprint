@echo off & cd /d "%~dp0" & title ET COMPENDIUM EXTRACTOR & echo [STATUS] Launching Extraction Protocol... & python -x "%~f0" %* & pause & goto :eof
import os
import sys
import subprocess
import importlib.util

# --- EXCEPTION THEORY EXTRACTOR (EMBEDDED PYTHON) ---

def install_and_import(package):
    """Checks for a library and installs it if missing."""
    if importlib.util.find_spec(package) is None:
        print(f"[*] Dependency '{package}' not found. Installing via pip...")
        try:
            subprocess.check_call([sys.executable, "-m", "pip", "install", package])
            print(f"[*] '{package}' installed.")
        except subprocess.CalledProcessError:
            print(f"[!] ERROR: Could not install '{package}'. Check your internet connection.")
            sys.exit(1)
    return importlib.import_module(package)

def main():
    # 1. SETUP
    pdf_filename = "ET Math Compendium.pdf"
    output_dir = "compendium_extracted"
    
    print(f"[*] Target File: {pdf_filename}")
    
    if not os.path.exists(pdf_filename):
        print(f"[!] CRITICAL ERROR: '{pdf_filename}' is missing!")
        print(f"    Current Folder: {os.getcwd()}")
        print("    Please move this script into the folder containing the PDF.")
        sys.exit(1)

    # 2. LOAD LIBRARIES
    try:
        pypdf = install_and_import("pypdf")
    except Exception as e:
        print(f"[!] Python Environment Error: {e}")
        sys.exit(1)

    # 3. PREPARE OUTPUT
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
        print(f"[*] Created output directory: {output_dir}")

    # 4. EXECUTE EXTRACTION
    try:
        reader = pypdf.PdfReader(pdf_filename)
        output_text_path = os.path.join(output_dir, "ET_Math_Compendium.txt")
        
        print(f"[*] Extracting text from {len(reader.pages)} pages...")
        
        with open(output_text_path, "w", encoding="utf-8") as f:
            for i, page in enumerate(reader.pages):
                text = page.extract_text()
                if text:
                    f.write(f"--- PAGE {i+1} ---\n")
                    f.write(text)
                    f.write("\n\n")
        
        print(f"[+] Text saved to: {output_text_path}")

        # 5. HANDLE ATTACHMENTS (Recursive Unzip logic)
        if hasattr(reader, "attachments") and reader.attachments:
            print(f"[*] Found embedded attachments. Extracting...")
            for filename, data in reader.attachments.items():
                if isinstance(data, list): data = data[0]
                
                try:
                    if hasattr(data, "get_data"):
                        file_bytes = data.get_data()
                    else:
                        file_bytes = data
                    
                    # Save attachment
                    out_path = os.path.join(output_dir, filename)
                    with open(out_path, "wb") as f:
                        f.write(file_bytes)
                    print(f"   [+] Extracted: {filename}")
                except Exception as att_err:
                    print(f"   [!] Failed to extract {filename}: {att_err}")
        else:
            print("[*] No embedded attachments found.")

        print("\n[SUCCESS] Extraction Complete.")
        print(f"[*] Check the folder: {os.path.abspath(output_dir)}")

    except Exception as e:
        print(f"\n[!] EXTRACTION FAILED: {e}")
        print("    Ensure the PDF is not encrypted or corrupted.")

if __name__ == "__main__":
    main()