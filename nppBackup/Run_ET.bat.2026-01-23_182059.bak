@echo off
setlocal

:: --- FORCE WINDOW TO STAY OPEN ---
if "%~1"=="__run__" goto :main
cmd /c ""%~f0" __run__"
pause
exit /b

:main
set "SOURCE_FILE=ET_Periodic_Omniverse.jsx"
set "PROJECT_DIR=et_runtime"

:: --- STEP 1: PRE-FLIGHT CHECKS ---
echo [1/7] Checking Environment...

if not exist "%SOURCE_FILE%" (
    echo [CRITICAL ERROR] Could not find %SOURCE_FILE%
    exit /b 1
)

where node >nul 2>nul
if %errorlevel% neq 0 (
    echo [CRITICAL ERROR] Node.js is not found.
    exit /b 1
)

where npm >nul 2>nul
if %errorlevel% neq 0 (
    echo [CRITICAL ERROR] NPM is not found.
    exit /b 1
)

echo Environment OK.

:: --- STEP 2: PROJECT SCAFFOLDING ---
echo [2/7] Creating Project Structure...

if not exist "%PROJECT_DIR%" mkdir "%PROJECT_DIR%"
cd "%PROJECT_DIR%" || goto :error

:: Create package.json (Fixed commas for valid JSON)
echo { > package.json
echo   "name": "et-omniverse", >> package.json
echo   "private": true, >> package.json
echo   "version": "1.0.0", >> package.json
echo   "type": "module", >> package.json
echo   "scripts": { >> package.json
echo     "start": "node server.js" >> package.json
echo   }, >> package.json
echo   "dependencies": { >> package.json
echo     "react": "18.2.0", >> package.json
echo     "react-dom": "18.2.0", >> package.json
echo     "lucide-react": "0.300.0", >> package.json
echo     "vite": "5.0.0", >> package.json
echo     "@vitejs/plugin-react": "4.2.1" >> package.json
echo   } >> package.json
echo } >> package.json

:: Create vite.config.js
echo import { defineConfig } from 'vite' > vite.config.js
echo import react from '@vitejs/plugin-react' >> vite.config.js
echo export default defineConfig({ >> vite.config.js
echo   plugins: [react()], >> vite.config.js
echo   clearScreen: false, >> vite.config.js
echo   logLevel: 'info', >> vite.config.js
echo   server: { middlewareMode: true } >> vite.config.js
echo }) >> vite.config.js

:: --- STEP 3: CREATE CUSTOM SERVER (THE LOG FORWARDER) ---
echo [3/7] Creating Console Bridge...

:: server.js - Intercepts browser errors and prints to CMD
echo import fs from 'fs'; > server.js
echo import path from 'path'; >> server.js
echo import { fileURLToPath } from 'url'; >> server.js
echo import { createServer } from 'vite'; >> server.js
echo import { exec } from 'child_process'; >> server.js
echo. >> server.js
echo const __dirname = path.dirname(fileURLToPath(import.meta.url)); >> server.js
echo. >> server.js
echo (async () =^> { >> server.js
echo   const vite = await createServer({ >> server.js
echo     configFile: path.resolve(__dirname, 'vite.config.js'), >> server.js
echo     root: __dirname, >> server.js
echo     server: { port: 5173 } >> server.js
echo   }); >> server.js
echo. >> server.js
echo   // MIDDLEWARE: Capture logs from browser >> server.js
echo   vite.middlewares.use('/__client_log', (req, res, next) =^> { >> server.js
echo     if (req.method === 'POST') { >> server.js
echo       let body = ''; >> server.js
echo       req.on('data', c =^> { body += c.toString(); }); >> server.js
echo       req.on('end', () =^> { >> server.js
echo         console.log('\x1b[31m[BROWSER ERROR]\x1b[0m'); >> server.js
echo         console.log('\x1b[31m' + body + '\x1b[0m'); >> server.js
echo         res.end('ok'); >> server.js
echo       }); >> server.js
echo       return; >> server.js
echo     } >> server.js
echo     next(); >> server.js
echo   }); >> server.js
echo. >> server.js
echo   await vite.listen(); >> server.js
echo   console.log('\x1b[32m[SERVER]\x1b[0m ET Omniverse running at http://localhost:5173'); >> server.js
echo   vite.printUrls(); >> server.js
echo   // Open Browser >> server.js
echo   const start = (process.platform == 'darwin'? 'open': process.platform == 'win32'? 'start': 'xdg-open'); >> server.js
echo   exec(start + ' http://localhost:5173'); >> server.js
echo })(); >> server.js

:: --- STEP 4: APP SCAFFOLDING ---
echo [4/7] Preparing App Files...

:: Create index.html
echo ^<!doctype html^> > index.html
echo ^<html lang="en"^> >> index.html
echo   ^<head^> >> index.html
echo     ^<meta charset="UTF-8" /^> >> index.html
echo     ^<meta name="viewport" content="width=device-width, initial-scale=1.0" /^> >> index.html
echo     ^<title^>ET Omniverse^</title^> >> index.html
echo     ^<script src="https://cdn.tailwindcss.com"^>^</script^> >> index.html
echo   ^</head^> >> index.html
echo   ^<body^> >> index.html
echo     ^<div id="root"^>^</div^> >> index.html
echo     ^<script type="module" src="/src/main.jsx"^>^</script^> >> index.html
echo   ^</body^> >> index.html
echo ^</html^> >> index.html

if not exist "src" mkdir "src"

:: Create Entry Point (main.jsx) - With LOG REPORTER
echo import React from 'react' > src\main.jsx
echo import { createRoot } from 'react-dom/client' >> src\main.jsx
echo. >> src\main.jsx
echo // --- ERROR REPORTER --- >> src\main.jsx
echo const logError = (err) =^> { >> src\main.jsx
echo   const msg = err instanceof Error ? err.stack : String(err); >> src\main.jsx
echo   fetch('/__client_log', { method: 'POST', body: msg }).catch(()=^>{}); >> src\main.jsx
echo   console.error(err); >> src\main.jsx
echo }; >> src\main.jsx
echo window.addEventListener('error', (e) =^> logError(e.error)); >> src\main.jsx
echo window.addEventListener('unhandledrejection', (e) =^> logError(e.reason)); >> src\main.jsx
echo. >> src\main.jsx
echo // Polyfills >> src\main.jsx
echo window.React = React; >> src\main.jsx
echo window.ReactDOM = { createRoot }; >> src\main.jsx
echo. >> src\main.jsx
echo // Load User Script >> src\main.jsx
echo import('./UserScript.jsx').catch(logError); >> src\main.jsx

:: Copy User Script
echo [5/7] Copying Source...
copy /Y "..\ET_Periodic_Omniverse.jsx" "src\UserScript.jsx" >nul
if %errorlevel% neq 0 goto :error

:: --- STEP 6: INSTALL ---
echo [6/7] Installing Dependencies...
call npm install
if %errorlevel% neq 0 (
    echo [ERROR] npm install failed.
    goto :error
)

:: --- STEP 7: RUN ---
echo [7/7] Launching...
echo.
echo ===================================================
echo  WATCH THIS WINDOW FOR ERRORS
echo  Browser errors will be printed here in RED.
echo ===================================================
echo.

node server.js
if %errorlevel% neq 0 goto :error

goto :end

:error
echo.
echo =======================================
echo  EXECUTION FAILED
echo =======================================
echo.
pause
exit /b 1

:end
pause