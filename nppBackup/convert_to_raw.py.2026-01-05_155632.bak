from astropy.io import fits
import numpy as np
import sys
import os

def extract_raw_data(input_file, output_file):
    if not os.path.exists(input_file):
        print(f"Error: File not found: {input_file}")
        sys.exit(1)

    print(f"Opening {input_file}...")
    # ignore_missing_end helps with slightly corrupt or non-standard FITS files
    with fits.open(input_file, memmap=True, ignore_missing_end=True) as hdul:
        print("\n--- FITS Structure ---")
        hdul.info()
        print("----------------------")

        target_data = None
        
        # Iterate through HDUs to find the map data
        for i, hdu in enumerate(hdul):
            # Skip PrimaryHDU if it's empty (common in FITS tables)
            if i == 0 and hdu.data is None:
                continue

            # Case 1: Binary Table (Standard for Planck/HEALPix)
            if hasattr(hdu, 'columns'):
                print(f"\nChecking Extension {i} (Table)...")
                col_names = hdu.columns.names
                print(f"Available columns: {col_names}")

                # Priority list for Intensity/Temperature maps
                # If these aren't found, we default to the first column [0]
                target_col = None
                priority_names = ['I_STOKES', 'TEMPERATURE', 'I', 'TEMP', 'SIGNAL']
                
                # Try to match a name
                for name in priority_names:
                    if name in col_names:
                        print(f"-> Found known intensity column: '{name}'")
                        target_col = hdu.data[name]
                        break
                
                # Fallback: Just take the first column if no name matches
                if target_col is None:
                    print(f"-> No standard name found. Defaulting to first column: '{col_names[0]}'")
                    target_col = hdu.data[col_names[0]]

                target_data = target_col
                break

            # Case 2: Image HDU (Direct Array)
            elif hdu.data is not None:
                print(f"\nFound Image Data in Extension {i}")
                target_data = hdu.data
                break

        if target_data is None:
            print("Error: Could not locate valid map data in any extension.")
            sys.exit(1)

        # Process the data
        print("\nProcessing data...")
        
        # 1. Flatten if it's multidimensional (HEALPix is usually 1D, but Images are 2D)
        if target_data.ndim > 1:
            print(f"Flattening array from shape {target_data.shape}...")
            target_data = target_data.flatten()
        
        # 2. Ensure standard float32 (Raw files usually expect 4 bytes per pixel)
        # Change to float64 if you specifically need double precision
        if target_data.dtype != np.float32:
            print(f"Converting dtype from {target_data.dtype} to float32...")
            target_data = target_data.astype(np.float32)

        print(f"Final Data: {target_data.size} pixels, {target_data.dtype}")
        print(f"Stats -> Min: {target_data.min()}, Max: {target_data.max()}")

        # Save purely raw binary
        print(f"\nWriting raw bytes to {output_file}...")
        target_data.tofile(output_file)

    # Verification
    if os.path.exists(output_file):
        size_mb = os.path.getsize(output_file) / (1024 * 1024)
        print(f"Success. Output size: {size_mb:.2f} MB")
        print("Note: This file contains NO headers. Read it using np.fromfile(..., dtype=np.float32)")
    else:
        print("Error: Output file was not created.")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python convert_to_raw_fixed.py <input.fits> <output.bin>")
        sys.exit(1)
    
    extract_raw_data(sys.argv[1], sys.argv[2])