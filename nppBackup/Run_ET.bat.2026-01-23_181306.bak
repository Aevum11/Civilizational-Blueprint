@echo off
setlocal

:: --- FORCE WINDOW TO STAY OPEN ---
if "%~1"=="__run__" goto :main
cmd /c ""%~f0" __run__"
pause
exit /b

:main
set "SOURCE_FILE=ET_Periodic_Omniverse.jsx"
set "PROJECT_DIR=et_runtime"

:: --- STEP 1: PRE-FLIGHT CHECKS ---
echo [1/6] Checking Environment...

if not exist "%SOURCE_FILE%" (
    echo [CRITICAL ERROR] Could not find %SOURCE_FILE%
    exit /b 1
)

where node >nul 2>nul
if %errorlevel% neq 0 (
    echo [CRITICAL ERROR] Node.js is not found.
    exit /b 1
)

where npm >nul 2>nul
if %errorlevel% neq 0 (
    echo [CRITICAL ERROR] NPM is not found.
    exit /b 1
)

echo Environment OK.

:: --- STEP 2: PROJECT SCAFFOLDING ---
echo [2/6] Creating Project Structure...

if not exist "%PROJECT_DIR%" mkdir "%PROJECT_DIR%"
cd "%PROJECT_DIR%" || exit /b 1

:: Create package.json
echo { > package.json
echo   "name": "et-omniverse", >> package.json
echo   "private": true, >> package.json
echo   "version": "1.0.0", >> package.json
echo   "type": "module", >> package.json
echo   "scripts": { >> package.json
echo     "dev": "vite", >> package.json
echo     "build": "vite build", >> package.json
echo     "preview": "vite preview" >> package.json
echo   }, >> package.json
echo   "dependencies": { >> package.json
echo     "react": "^18.2.0", >> package.json
echo     "react-dom": "^18.2.0", >> package.json
echo     "lucide-react": "^0.300.0" >> package.json
echo   }, >> package.json
echo   "devDependencies": { >> package.json
echo     "@vitejs/plugin-react": "^4.2.1", >> package.json
echo     "vite": "^5.0.0" >> package.json
echo   } >> package.json
echo } >> package.json

:: Create vite.config.js
echo import { defineConfig } from 'vite' > vite.config.js
echo import react from '@vitejs/plugin-react' >> vite.config.js
echo export default defineConfig({ >> vite.config.js
echo   plugins: [react()], >> vite.config.js
echo   server: { open: true }, >> vite.config.js
echo   esbuild: { >> vite.config.js
echo     loader: 'jsx', >> vite.config.js
echo     include: /src\/.*\.jsx?$/, >> vite.config.js
echo     exclude: [] >> vite.config.js
echo   }, >> vite.config.js
echo   optimizeDeps: { >> vite.config.js
echo     esbuildOptions: { >> vite.config.js
echo       loader: { >> vite.config.js
echo         '.js': 'jsx', >> vite.config.js
echo       }, >> vite.config.js
echo     }, >> vite.config.js
echo   }, >> vite.config.js
echo }) >> vite.config.js

:: Create index.html (With Error Trap)
echo ^<!doctype html^> > index.html
echo ^<html lang="en"^> >> index.html
echo   ^<head^> >> index.html
echo     ^<meta charset="UTF-8" /^> >> index.html
echo     ^<meta name="viewport" content="width=device-width, initial-scale=1.0" /^> >> index.html
echo     ^<title^>ET Omniverse^</title^> >> index.html
echo     ^<script src="https://cdn.tailwindcss.com"^>^</script^> >> index.html
echo     ^<style^> >> index.html
echo       body { background-color: #0f172a; color: white; font-family: sans-serif; } >> index.html
echo       #app-error { display: none; padding: 20px; background: #450a0a; color: #fca5a5; border: 2px solid red; margin: 20px; white-space: pre-wrap; font-family: monospace; } >> index.html
echo     ^</style^> >> index.html
echo   ^</head^> >> index.html
echo   ^<body^> >> index.html
echo     ^<div id="app-error"^>^</div^> >> index.html
echo     ^<div id="root"^>^</div^> >> index.html
echo     ^<script^> >> index.html
echo       window.onerror = function(msg, url, line) { >> index.html
echo         var el = document.getElementById('app-error'); >> index.html
echo         el.style.display = 'block'; >> index.html
echo         el.innerText = 'CRITICAL ERROR:\n' + msg + '\nLine: ' + line; >> index.html
echo         return false; >> index.html
echo       }; >> index.html
echo     ^</script^> >> index.html
echo     ^<script type="module" src="/src/main.jsx"^>^</script^> >> index.html
echo   ^</body^> >> index.html
echo ^</html^> >> index.html

:: --- STEP 3: SOURCE CODE PREP ---
echo [3/6] Preparing Source Code...

if not exist "src" mkdir "src"

:: Create Entry Point (main.jsx)
echo import React from 'react' > src\main.jsx
echo import { createRoot } from 'react-dom/client' >> src\main.jsx
echo. >> src\main.jsx
echo // Polyfill globals to fix import issues >> src\main.jsx
echo window.React = React; >> src\main.jsx
echo window.ReactDOM = { createRoot }; >> src\main.jsx
echo. >> src\main.jsx
echo // Load user script >> src\main.jsx
echo try { >> src\main.jsx
echo   import('./UserScript.jsx'); >> src\main.jsx
echo } catch (e) { >> src\main.jsx
echo   console.error(e); >> src\main.jsx
echo } >> src\main.jsx

:: Copy User Script
echo Copying Source...
copy /Y "..\ET_Periodic_Omniverse.jsx" "src\UserScript.jsx" >nul

:: --- STEP 4: DEPENDENCY INSTALLATION ---
echo [4/6] Installing Dependencies...
call npm install
if %errorlevel% neq 0 (
    echo [ERROR] npm install failed.
    exit /b 1
)

:: --- STEP 5: LAUNCH ---
echo [5/6] Launching Server...
echo.
echo =======================================
echo  ET OMNIVERSE RUNNING
echo  Starting local server...
echo =======================================
echo.

call npm run dev