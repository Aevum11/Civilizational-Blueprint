import sys
import os
import json
import subprocess

# --- Fix for "IDCompositionDevice4" / Direct Composition Errors ---
# This suppresses the GPU compositing warning/error on Windows
os.environ["QTWEBENGINE_CHROMIUM_FLAGS"] = "--disable-gpu-compositing"

# --- Auto-Install Dependencies Logic ---
try:
    from PyQt6.QtWidgets import (QApplication, QMainWindow, QFileDialog, 
                                 QVBoxLayout, QWidget, QTabWidget, QMessageBox)
    from PyQt6.QtWebEngineWidgets import QWebEngineView
    from PyQt6.QtCore import QUrl, Qt, QEvent
    from PyQt6.QtGui import QAction, QDragEnterEvent, QDropEvent, QIcon, QShortcut, QKeySequence
    import markdown
    from pygments.formatters import HtmlFormatter
    import pymdownx # Check for math support library
except ImportError:
    # If imports fail, launch a temporary Tkinter window to show installation progress
    import tkinter as tk
    from tkinter import messagebox
    
    root = tk.Tk()
    root.title("Setup")
    
    width, height = 400, 120
    x = (root.winfo_screenwidth() // 2) - (width // 2)
    y = (root.winfo_screenheight() // 2) - (height // 2)
    root.geometry(f"{width}x{height}+{x}+{y}")
    
    tk.Label(root, text="First Run: Installing dependencies...", font=("Segoe UI", 10, "bold")).pack(pady=(20, 5))
    tk.Label(root, text="(PyQt6, Markdown, Pygments, Pymdown-Extensions)\nThis may take a minute...", font=("Segoe UI", 8)).pack(pady=5)
    
    root.update()

    try:
        # Added pymdown-extensions for proper Math support
        subprocess.check_call([sys.executable, "-m", "pip", "install", "PyQt6", "PyQt6-WebEngine", "markdown", "pygments", "pymdown-extensions"])
        root.destroy()
        os.execv(sys.executable, [sys.executable] + sys.argv)
    except Exception as e:
        messagebox.showerror("Installation Failed", f"Error: {e}")
        sys.exit(1)

# --- Configuration & Styling ---
BASE_CSS = """
<style>
    :root {
        /* Light Mode (Default) */
        --bg-color: #ffffff;
        --text-color: #24292f;
        --link-color: #0969da;
        --code-bg: #f6f8fa;
        --code-text: #24292f;
        --border-color: #d0d7de;
        --quote-color: #57606a;
        --quote-border: #d0d7de;
        --table-header-bg: #f6f8fa;
        --table-row-even: #ffffff;
        --table-row-hover: #f6f8fa;
        --pre-border-width: 2px;
    }

    body.dark-mode {
        /* Dark Mode Overrides */
        --bg-color: #0d1117;
        --text-color: #e6edf3;
        --link-color: #79c0ff; /* Much brighter blue for visibility */
        --code-bg: #161b22;
        --code-text: #e6edf3;
        --border-color: #30363d;
        --quote-color: #8b949e;
        --quote-border: #30363d;
        --table-header-bg: #161b22;
        --table-row-even: #0d1117;
        --table-row-hover: #161b22;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background-color: var(--bg-color);
        margin: 0;
        padding: 32px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        transition: background-color 0.3s, color 0.3s;
    }

    /* Headers */
    h1, h2, h3, h4, h5, h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
        color: var(--text-color);
    }
    h1 { font-size: 2em; padding-bottom: 0.3em; border-bottom: 1px solid var(--border-color); }
    h2 { font-size: 1.5em; padding-bottom: 0.3em; border-bottom: 1px solid var(--border-color); }

    /* Links */
    a { color: var(--link-color); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Quotes */
    blockquote {
        margin: 0 0 16px;
        padding: 0 1em;
        color: var(--quote-color);
        border-left: 0.25em solid var(--quote-border);
    }

    /* Code Blocks */
    pre {
        background-color: var(--code-bg);
        border-radius: 6px;
        padding: 16px;
        overflow: auto;
        line-height: 1.45;
        border: var(--pre-border-width) solid var(--border-color); /* Thicker border */
    }
    
    /* Inline Code */
    code {
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        padding: 0.2em 0.4em;
        margin: 0;
        font-size: 85%;
        background-color: var(--code-bg);
        color: var(--code-text);
        border-radius: 6px;
    }
    
    pre code {
        padding: 0;
        background-color: transparent;
        font-size: 100%;
        color: inherit;
    }
    
    /* FIX: Remove Red Boxes from Pygments Errors (Special chars) */
    /* We target multiple potential error classes to be safe */
    .codehilite .err, .err, span.err {
        border: none !important;
        background-color: transparent !important;
        color: inherit !important;
        outline: none !important;
    }

    /* Dark Mode Syntax Highlighting Visibility Boost */
    body.dark-mode .codehilite {
        filter: brightness(1.3) contrast(1.1);
    }
    /* Specific override for Pygments 'friendly' theme dark blue in Dark Mode */
    body.dark-mode .codehilite .nc, 
    body.dark-mode .codehilite .nf,
    body.dark-mode .codehilite .ne {
        color: #d2a8ff !important; /* Make functions/classes purple-ish light */
    }
    body.dark-mode .codehilite .k, 
    body.dark-mode .codehilite .kn,
    body.dark-mode .codehilite .kp {
        color: #ff7b72 !important; /* Make keywords reddish light */
    }
    body.dark-mode .codehilite .s2,
    body.dark-mode .codehilite .s1 {
        color: #a5d6ff !important; /* Make strings light blue */
    }

    /* Tables */
    table {
        border-spacing: 0;
        border-collapse: collapse;
        display: block;
        width: 100%;
        width: max-content;
        max-width: 100%;
        overflow: auto;
        margin-bottom: 16px;
    }
    tr { background-color: var(--table-row-even); border-top: 1px solid var(--border-color); }
    tr:nth-child(2n) { background-color: var(--table-header-bg); }
    tr:hover { background-color: var(--table-row-hover); }
    th, td {
        padding: 6px 13px;
        border: 1px solid var(--border-color);
    }
    th { font-weight: 600; background-color: var(--table-header-bg); }

    /* Images */
    img {
        max-width: 100%;
        box-sizing: content-box;
        background-color: var(--bg-color);
    }
    
    hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: var(--border-color);
        border: 0;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 12px; height: 12px; }
    ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 6px; border: 3px solid var(--bg-color); }
    ::-webkit-scrollbar-track { background-color: var(--bg-color); }
    
    /* MathJax Specifics */
    .arithmatex {
        display: inline-block;
    }
</style>
"""

class DropFriendlyWebView(QWebEngineView):
    """
    A custom WebEngineView that intentionally ignores drag events.
    This forces the drag event to bubble up to the parent (MainWindow),
    which handles the actual file loading.
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAcceptDrops(False) 

class MarkdownViewer(QMainWindow):
    def __init__(self):
        super().__init__()

        self.setWindowTitle("Markdown Viewer Pro")
        self.resize(1100, 800)
        
        # --- Dark Mode Default ---
        self.is_dark_mode = True

        # --- Enable Drag and Drop on the Main Window ---
        self.setAcceptDrops(True)

        # --- Setup Tabs ---
        self.tabs = QTabWidget()
        self.tabs.setTabsClosable(True)
        self.tabs.tabCloseRequested.connect(self.close_tab)
        self.tabs.setDocumentMode(True)
        self.setCentralWidget(self.tabs)

        # --- Setup Menus ---
        self.create_menu()

        # --- Load Initial Tab ---
        self.load_markdown(self.get_welcome_markdown(), title="Welcome")

    def create_menu(self):
        menubar = self.menuBar()
        
        # File Menu
        file_menu = menubar.addMenu("&File")
        
        open_action = QAction("&Open File...", self)
        open_action.setShortcut("Ctrl+O")
        open_action.triggered.connect(self.open_file_dialog)
        file_menu.addAction(open_action)

        close_tab_action = QAction("Close &Tab", self)
        close_tab_action.setShortcut("Ctrl+W")
        close_tab_action.triggered.connect(self.close_current_tab)
        file_menu.addAction(close_tab_action)

        file_menu.addSeparator()

        exit_action = QAction("E&xit", self)
        exit_action.setShortcut("Ctrl+Q")
        exit_action.triggered.connect(self.close)
        file_menu.addAction(exit_action)

        # View Menu
        view_menu = menubar.addMenu("&View")
        
        self.dark_mode_action = QAction("Dark Mode", self, checkable=True)
        self.dark_mode_action.setShortcut("Ctrl+D")
        self.dark_mode_action.setChecked(self.is_dark_mode) # Check it by default
        self.dark_mode_action.triggered.connect(self.toggle_dark_mode)
        view_menu.addAction(self.dark_mode_action)

    # --- Drag and Drop Logic ---
    def dragEnterEvent(self, event: QDragEnterEvent):
        if event.mimeData().hasUrls():
            event.acceptProposedAction()
        else:
            event.ignore()

    def dropEvent(self, event: QDropEvent):
        files = [u.toLocalFile() for u in event.mimeData().urls()]
        for file_path in files:
            if os.path.isfile(file_path):
                self.load_file_from_path(file_path)

    # --- File Handling ---
    def open_file_dialog(self):
        file_name, _ = QFileDialog.getOpenFileName(
            self, "Open Markdown File", "", "Markdown Files (*.md);;Text Files (*.txt);;All Files (*)"
        )
        if file_name:
            self.load_file_from_path(file_name)

    def load_file_from_path(self, file_path):
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            self.load_markdown(content, base_path=os.path.dirname(file_path), title=os.path.basename(file_path))
        except Exception as e:
            # Simple error handling
            print(f"Error: {e}")

    # --- Tab Management ---
    def close_tab(self, index):
        if self.tabs.count() > 1:
            self.tabs.removeTab(index)
        else:
            self.tabs.removeTab(index)
            self.load_markdown(self.get_welcome_markdown(), title="Welcome")

    def close_current_tab(self):
        self.close_tab(self.tabs.currentIndex())

    # --- Rendering Logic ---
    def load_markdown(self, markdown_text, base_path=None, title="Untitled"):
        # 1. Convert Markdown to HTML
        # Added 'pymdownx.arithmatex' for LaTeX support
        html_content = markdown.markdown(
            markdown_text, 
            extensions=[
                'fenced_code', 'tables', 'codehilite', 'nl2br', 'sane_lists',
                'pymdownx.arithmatex'
            ],
            extension_configs={
                'pymdownx.arithmatex': {
                    'generic': True,  # Output generic format for MathJax
                    'smart_dollar': True # Enable $...$ detection
                }
            }
        )

        # 2. Get Syntax Highlighting CSS
        formatter = HtmlFormatter(style='friendly') 
        pygments_css = formatter.get_style_defs('.codehilite')
        
        # 3. Construct HTML
        base_tag = f'<base href="file:///{base_path.replace(os.sep, "/")}/">' if base_path else ""
        
        # Determine initial theme class
        body_class = "dark-mode" if self.is_dark_mode else ""

        full_html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            {base_tag}
            {BASE_CSS}
            <style>
                {pygments_css}
                /* Ensure pygments bg allows transparency for our theme vars to work */
                .codehilite {{ background: transparent !important; }}
                .codehilite pre {{ background: transparent !important; }}
            </style>
            
            <!-- MathJax Configuration & Script -->
            <script>
            window.MathJax = {{
              tex: {{
                inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],
                displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],
                processEscapes: true
              }},
              options: {{
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
              }}
            }};
            </script>
            <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        </head>
        <body class="{body_class}">
            {html_content}
        </body>
        </html>
        """

        # 4. Create New Tab
        view = DropFriendlyWebView()
        view.setContextMenuPolicy(Qt.ContextMenuPolicy.NoContextMenu)
        view.setHtml(full_html)
        
        # Add to tabs and set as current
        index = self.tabs.addTab(view, title)
        self.tabs.setCurrentIndex(index)

    # --- Dark Mode Logic ---
    def toggle_dark_mode(self):
        self.is_dark_mode = self.dark_mode_action.isChecked()
        
        # Toggle class on ALL open tabs via JavaScript
        js_code = "document.body.classList.toggle('dark-mode');"
        for i in range(self.tabs.count()):
            view = self.tabs.widget(i)
            if isinstance(view, QWebEngineView):
                view.page().runJavaScript(js_code)

    def get_welcome_markdown(self):
        return r"""
# Markdown Viewer Pro

**Features Enabled:**
1.  [x] **Tabs**: Open multiple files.
2.  [x] **Drag & Drop**: Working properly!
3.  [x] **Dark Mode**: Default enabled.
4.  [x] **Math**: LaTeX equations supported.

## Equation Test
Display Math:
$$\mathbb{P} \cap \mathbb{D} = \emptyset, \quad \mathbb{D} \cap \mathbb{T} = \emptyset, \quad \mathbb{T} \cap \mathbb{P} = \emptyset$$

Inline Math Test:
The set intersection $P \cap D = \emptyset$ should render correctly inline.

## Code Example
```python
def check_visibility():
    # This comment should be readable in dark mode
    return "Everything looks great!"
```

> "Design is intelligence made visible."
"""

if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyle("Fusion") 
    
    viewer = MarkdownViewer()
    viewer.show()
    
    sys.exit(app.exec())