@echo off
setlocal

set "JSX_FILE=ET_Periodic_Omniverse.jsx"
set "APP_FILE=ET_Application.html"

if not exist "%JSX_FILE%" (
    echo [ERROR] %JSX_FILE% not found.
    echo Please ensure the file is named exactly: ET_Periodic_Omniverse.jsx
    pause
    exit /b
)

echo Packaging ET Omniverse...

:: 1. Write the HTML Header
(
    echo ^<!DOCTYPE html^>
    echo ^<html lang="en"^>
    echo ^<head^>
    echo     ^<meta charset="UTF-8"^>
    echo     ^<meta name="viewport" content="width=device-width, initial-scale=1.0"^>
    echo     ^<title^>ET Omniverse^</title^>
    echo     ^<style^>
    echo         body { background: #0f172a; color: #e2e8f0; font-family: system-ui, sans-serif; margin: 0; }
    echo         #loading { padding: 40px; text-align: center; color: #38bdf8; font-size: 1.2rem; }
    echo         #error-box { display: none; background: #450a0a; color: #fca5a5; padding: 20px; border-bottom: 2px solid red; white-space: pre-wrap; font-family: monospace; }
    echo     ^</style^>
    echo     ^<!-- React & Babel --^>
    echo     ^<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"^>^</script^>
    echo     ^<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"^>^</script^>
    echo     ^<script src="https://unpkg.com/@babel/standalone/babel.min.js"^>^</script^>
    echo     ^<!-- Tailwind (Optional) --^>
    echo     ^<script src="https://cdn.tailwindcss.com"^>^</script^>
    echo ^</head^>
    echo ^<body^>
    echo     ^<div id="error-box"^>^</div^>
    echo     ^<div id="root"^>^</div^>
    echo     ^<div id="loading"^>Initializing Exception Theory...^</div^>
    echo.
    echo     ^<!-- RAW CODE STORAGE --^>
    echo     ^<script id="raw-jsx" type="text/plain"^>
) > "%APP_FILE%"

:: 2. DUMP THE RAW JSX FILE
type "%JSX_FILE%" >> "%APP_FILE%"

:: 3. Write the JS Loader
(
    echo     ^</script^>
    echo.
    echo     ^<script type="text/babel"^>
    echo         // --- ERROR HANDLER ---
    echo         window.onerror = function^(msg, url, line, col, error^) {
    echo             const box = document.getElementById^('error-box'^);
    echo             box.style.display = 'block';
    echo             box.innerHTML = '^<strong^>CRITICAL ERROR:^</strong^>\n' + msg + '\nLine: ' + line;
    echo             document.getElementById^('loading'^).style.display = 'none';
    echo             return false;
    echo         };
    echo.
    echo         // --- POLYFILLS ---
    echo         const { useState, useMemo, useEffect, useRef } = React;
    echo         // Icon Mock
    echo         const Icon = ^(p^) =^> ^<svg {...p} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"^>^<rect x="2" y="2" width="20" height="20" rx="5" ry="5"^>^</rect^>^</svg^>;
    echo         const ChevronLeft=Icon; const ChevronRight=Icon; const Home=Icon; const Atom=Icon; 
    echo         const Layers=Icon; const Zap=Icon; const Activity=Icon; const Target=Icon; 
    echo         const Clock=Icon; const Shield=Icon; const AlertTriangle=Icon; const Info=Icon;
    echo.
    echo         try {
    echo             // 1. READ CODE
    echo             let code = document.getElementById^('raw-jsx'^).innerHTML;
    echo             
    echo             // 2. CLEAN CODE (Remove imports/exports)
    echo             code = code.replace^(/^\s*import .*$/gm, ''^);
    echo             code = code.replace^(/^\s*export default/gm, ''^);
    echo.
    echo             // 3. COMPILE
    echo             const compiled = Babel.transform^(code, { presets: ['react'] }^).code;
    echo.
    echo             // 4. EXECUTE
    echo             eval^(compiled^);
    echo.
    echo             // 5. RENDER
    echo             const root = ReactDOM.createRoot^(document.getElementById^('root'^)^);
    echo             root.render^(^<App /^>^);
    echo             document.getElementById^('loading'^).style.display = 'none';
    echo         } catch ^(e^) {
    echo             throw e; // Handled by window.onerror
    echo         }
    echo     ^</script^>
    echo ^</body^>
    echo ^</html^>
) >> "%APP_FILE%"

echo Launching...
start "" "%APP_FILE%"
endlocal