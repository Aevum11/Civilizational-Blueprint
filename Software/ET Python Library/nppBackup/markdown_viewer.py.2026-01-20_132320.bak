import sys
import os
import json
import subprocess

# --- Auto-Install Dependencies Logic ---
try:
    from PyQt6.QtWidgets import (QApplication, QMainWindow, QFileDialog, 
                                 QVBoxLayout, QWidget, QLabel, QProgressBar)
    from PyQt6.QtWebEngineWidgets import QWebEngineView
    from PyQt6.QtCore import QUrl, Qt, QSize
    from PyQt6.QtGui import QIcon, QAction, QDragEnterEvent, QDropEvent
    import markdown
    from pygments.formatters import HtmlFormatter
except ImportError:
    # If imports fail, launch a temporary Tkinter window to show installation progress
    import tkinter as tk
    from tkinter import messagebox
    
    root = tk.Tk()
    root.title("Setup")
    
    # Center the splash screen
    width, height = 400, 120
    x = (root.winfo_screenwidth() // 2) - (width // 2)
    y = (root.winfo_screenheight() // 2) - (height // 2)
    root.geometry(f"{width}x{height}+{x}+{y}")
    
    tk.Label(root, text="First Run: Installing dependencies...", font=("Segoe UI", 10, "bold")).pack(pady=(20, 5))
    tk.Label(root, text="(PyQt6, PyQt6-WebEngine, Markdown, Pygments)\nThis may take a minute depending on your internet.", font=("Segoe UI", 8)).pack(pady=5)
    
    # Force update so the window appears before the blocking call
    root.update()

    try:
        # Install packages
        subprocess.check_call([sys.executable, "-m", "pip", "install", "PyQt6", "PyQt6-WebEngine", "markdown", "pygments"])
        
        # Restart the script to load the new modules
        root.destroy()
        os.execv(sys.executable, [sys.executable] + sys.argv)
    except Exception as e:
        messagebox.showerror("Installation Failed", f"Could not install dependencies automatically.\n\nPlease run this command manually:\npip install PyQt6 PyQt6-WebEngine markdown pygments\n\nError: {e}")
        sys.exit(1)

# --- Configuration & Styling (Claude-like) ---
CLAUDE_CSS = """
<style>
    :root {
        --bg-color: #ffffff;
        --text-color: #2D2D2D;
        --link-color: #D9603B;
        --code-bg: #F4F4F3;
        --border-color: #E0E0E0;
        --font-main: "Segoe UI", "Inter", system-ui, -apple-system, sans-serif;
        --font-mono: "Consolas", "Monaco", monospace;
    }

    body {
        font-family: var(--font-main);
        line-height: 1.7;
        color: var(--text-color);
        background-color: var(--bg-color);
        margin: 0;
        padding: 40px;
        max-width: 900px; /* Reading width */
        margin-left: auto;
        margin-right: auto;
    }

    /* Headers */
    h1, h2, h3, h4, h5, h6 {
        font-weight: 600;
        color: #1a1a1a;
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        line-height: 1.3;
    }
    h1 { font-size: 2.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
    h2 { font-size: 2em; }
    h3 { font-size: 1.5em; }

    /* Text Elements */
    p { margin-bottom: 1.2em; }
    
    a { 
        color: var(--link-color); 
        text-decoration: none; 
        font-weight: 500;
        transition: color 0.2s;
    }
    a:hover { text-decoration: underline; color: #b04626; }

    blockquote {
        border-left: 4px solid var(--link-color);
        margin: 1.5em 0;
        padding: 0.5em 1.5em;
        background: #fafafa;
        color: #555;
        font-style: italic;
    }

    /* Lists */
    ul, ol { margin-bottom: 1.2em; padding-left: 1.5em; }
    li { margin-bottom: 0.5em; }

    /* Code Blocks (The Claude Look) */
    pre {
        background-color: var(--code-bg);
        border-radius: 8px;
        padding: 16px;
        overflow-x: auto;
        font-family: var(--font-mono);
        font-size: 0.9em;
        border: 1px solid #eeeeee;
        box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    }
    
    code {
        font-family: var(--font-mono);
        background-color: var(--code-bg);
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-size: 0.9em;
        color: #d73a49; /* Inline code highlight */
    }
    
    pre code {
        background-color: transparent;
        padding: 0;
        color: inherit;
        border-radius: 0;
    }

    /* Tables */
    table {
        border-collapse: collapse;
        width: 100%;
        margin: 1.5em 0;
        font-size: 0.95em;
    }
    th {
        text-align: left;
        padding: 12px;
        background-color: #f8f9fa;
        border-bottom: 2px solid var(--border-color);
        font-weight: 600;
    }
    td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-color);
    }
    tr:hover { background-color: #fcfcfc; }

    /* Images */
    img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 1.5em 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    hr {
        border: 0;
        height: 1px;
        background: var(--border-color);
        margin: 2em 0;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: #fff; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #bbb; }
</style>
"""

class MarkdownViewer(QMainWindow):
    def __init__(self):
        super().__init__()

        self.setWindowTitle("Markdown Viewer Pro")
        self.resize(1100, 800)
        
        # Enable Drag and Drop
        self.setAcceptDrops(True)

        # Setup Main Layout
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        layout = QVBoxLayout(main_widget)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        # Web Engine View (The "Best Possible" Renderer)
        self.web_view = QWebEngineView()
        self.web_view.setContextMenuPolicy(Qt.ContextMenuPolicy.NoContextMenu) # Clean look
        layout.addWidget(self.web_view)

        # Setup Menu
        self.create_menu()

        # Load Welcome Screen
        self.load_markdown(self.get_welcome_markdown())

    def create_menu(self):
        menubar = self.menuBar()
        file_menu = menubar.addMenu("&File")

        open_action = QAction("&Open File...", self)
        open_action.setShortcut("Ctrl+O")
        open_action.triggered.connect(self.open_file_dialog)
        file_menu.addAction(open_action)

        exit_action = QAction("E&xit", self)
        exit_action.setShortcut("Ctrl+Q")
        exit_action.triggered.connect(self.close)
        file_menu.addAction(exit_action)

    # --- Drag and Drop Logic ---
    def dragEnterEvent(self, event: QDragEnterEvent):
        if event.mimeData().hasUrls():
            event.accept()
        else:
            event.ignore()

    def dropEvent(self, event: QDropEvent):
        files = [u.toLocalFile() for u in event.mimeData().urls()]
        if files:
            # Open the first file dropped
            self.load_file_from_path(files[0])

    # --- File Handling ---
    def open_file_dialog(self):
        file_name, _ = QFileDialog.getOpenFileName(
            self, "Open Markdown File", "", "Markdown Files (*.md);;Text Files (*.txt);;All Files (*)"
        )
        if file_name:
            self.load_file_from_path(file_name)

    def load_file_from_path(self, file_path):
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            self.setWindowTitle(f"Markdown Viewer Pro - {os.path.basename(file_path)}")
            self.load_markdown(content, base_path=os.path.dirname(file_path))
        except Exception as e:
            print(f"Error reading file: {e}")

    # --- Rendering Logic ---
    def load_markdown(self, markdown_text, base_path=None):
        # 1. Convert Markdown to HTML
        # We enable 'fenced_code' for ``` blocks, 'tables' for tables, 
        # and 'codehilite' for syntax highlighting colors
        html_content = markdown.markdown(
            markdown_text, 
            extensions=['fenced_code', 'tables', 'codehilite', 'nl2br', 'sane_lists']
        )

        # 2. Get Syntax Highlighting CSS (Pygments)
        formatter = HtmlFormatter(style='friendly')
        pygments_css = formatter.get_style_defs('.codehilite')
        
        # 3. Construct Full HTML Page
        # We inject the base_path if provided so images resolve correctly
        base_tag = f'<base href="file:///{base_path.replace(os.sep, "/")}/">' if base_path else ""

        full_html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            {base_tag}
            {CLAUDE_CSS}
            <style>
                /* Pygments Syntax Highlighting Overrides */
                {pygments_css}
                .codehilite {{ background: transparent !important; }}
            </style>
        </head>
        <body>
            {html_content}
        </body>
        </html>
        """

        # 4. Load into Web View
        self.web_view.setHtml(full_html)

    def get_welcome_markdown(self):
        return """
# Welcome to Markdown Viewer Pro

Drag and drop a file anywhere on this window to open it.

## Why is this the "Best Possible"?
Unlike basic text widgets, this viewer uses a **full web browser engine** (Chromium via Qt). This allows for:

1.  **Beautiful Typography**: Using CSS variables for a clean, reading-focused layout.
2.  **Syntax Highlighting**: Python, JavaScript, HTML, and more.
3.  **Modern Tables**: Clean borders and hover states.

## Code Example
```python
def drag_and_drop_demo():
    print("Just drop a file here!")
    return True
```

## Supported Features
- [x] **Drag & Drop**
- [x] Headers & Formatting
- [x] Blockquotes
- [x] Tables
- [x] Images (Local & Remote)

> "Design is not just what it looks like and feels like. Design is how it works."
> â€” Steve Jobs

---
*Ready when you are. Press Ctrl+O or drop a file.*
"""

if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyle("Fusion") # Ensure consistent look across platforms
    
    viewer = MarkdownViewer()
    viewer.show()
    
    sys.exit(app.exec())