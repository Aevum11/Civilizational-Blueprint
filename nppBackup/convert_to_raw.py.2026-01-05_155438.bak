from astropy.io import fits
import numpy as np
import sys
import os

if len(sys.argv) != 3:
    print("Usage: python extract_pure_cmb.py <input.fits> <output.bin>")
    print("Example: python extract_pure_cmb.py COM_CMB_IQU-smica_2048_R3.00.fits pure_cmb_intensity.bin")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

if not os.path.exists(input_file):
    print(f"Error: File not found: {input_file}")
    sys.exit(1)

print(f"Opening {input_file}...")
hdul = fits.open(input_file, memmap=True)  # Memory-map for huge files
print("\nFITS Structure:")
hdul.info()

# Find the extension with the map data (usually extension 1 for Planck CMB)
data_ext = None
for i, h in enumerate(hdul):
    if h.data is not None and hasattr(h.data, 'names'):  # Binary table with columns
        if any(name in h.data.names for name in ['I_STOKES', 'TEMPERATURE', 'I', 'TEMP']):
            data_ext = i
            break
    elif h.data is not None and len(h.data.shape) >= 1:  # Array HDU
        data_ext = i
        break

if data_ext is None:
    print("\nError: No map data extension found. Check hdul.info() output above.")
    hdul.close()
    sys.exit(1)

print(f"\nUsing extension {data_ext} for data.")

# Extract temperature/intensity column
data_hdu = hdul[data_ext]
raw_data = None

if hasattr(data_hdu.data, 'names'):  # Binary table (most Planck CMB maps)
    possible_names = ['I_STOKES', 'TEMPERATURE', 'I', 'TEMP', 'FIELD_0', data_hdu.data.names[0]]
    for name in possible_names:
        if name in data_hdu.data.names:
            print(f"Found intensity column: {name}")
            raw_data = data_hdu.data[name]
            break
else:  # Direct array HDU
    print("Found direct array data — using full array (assuming intensity map)")
    raw_data = data_hdu.data

if raw_data is None:
    print("\nError: Could not find temperature/intensity column. Common names tried.")
    print("Available columns:", data_hdu.data.names if hasattr(data_hdu.data, 'names') else "N/A")
    hdul.close()
    sys.exit(1)

# Flatten if needed and ensure float32
if len(raw_data.shape) > 1:
    print(f"Flattening multi-dimensional array {raw_data.shape} to 1D...")
    raw_data = raw_data.flatten()

raw_data = np.asarray(raw_data, dtype=np.float32)

print(f"\nExtracted pure intensity array: {raw_data.shape} pixels, {raw_data.dtype}")
print(f"Min: {raw_data.min():.6f}, Max: {raw_data.max():.6f}, Mean: {raw_data.mean():.6f}")

# Save pure raw bytes — NO headers, NO metadata
raw_data.tofile(output_file)
print(f"\nPure raw CMB intensity saved to: {output_file}")
print(f"File size: {os.path.getsize(output_file) / (1024**3):.2f} GB")

hdul.close()
print("\nDone. Scan this .bin file directly — it's nothing but the temperature fluctuation values.")