@echo off
setlocal

:: --- FORCE WINDOW TO STAY OPEN ---
:: This wrapper ensures that if the script crashes or finishes, the window waits for you.
if "%~1"=="__run__" goto :main
cmd /c ""%~f0" __run__"
pause
exit /b

:main
:: CONFIGURATION
set "SOURCE_FILE=ET_Periodic_Omniverse.jsx"
set "PROJECT_DIR=et_runtime"

:: --- STEP 1: PRE-FLIGHT CHECKS ---
echo [1/6] Checking Environment...

if not exist "%SOURCE_FILE%" (
    echo [CRITICAL ERROR] Could not find %SOURCE_FILE%
    echo Please ensure the file is named exactly: ET_Periodic_Omniverse.jsx
    exit /b 1
)

where node >nul 2>nul
if %errorlevel% neq 0 (
    echo [CRITICAL ERROR] Node.js is not found in your PATH.
    echo Please install Node.js from https://nodejs.org/
    exit /b 1
)

where npm >nul 2>nul
if %errorlevel% neq 0 (
    echo [CRITICAL ERROR] NPM is not found in your PATH.
    echo Please ensure NPM is installed.
    exit /b 1
)

echo Environment OK.

:: --- STEP 2: PROJECT SCAFFOLDING ---
echo [2/6] Creating Project Structure...

if not exist "%PROJECT_DIR%" mkdir "%PROJECT_DIR%"
cd "%PROJECT_DIR%" || (
    echo [ERROR] Failed to enter project directory.
    exit /b 1
)

:: Create package.json
(
echo {
echo   "name": "et-omniverse",
echo   "private": true,
echo   "version": "1.0.0",
echo   "type": "module",
echo   "scripts": {
echo     "dev": "vite",
echo     "build": "vite build",
echo     "preview": "vite preview"
echo   },
echo   "dependencies": {
echo     "react": "^18.2.0",
echo     "react-dom": "^18.2.0",
echo     "lucide-react": "^0.300.0"
echo   },
echo   "devDependencies": {
echo     "@vitejs/plugin-react": "^4.2.1",
echo     "vite": "^5.0.0"
echo   }
echo }
) > package.json

:: Create vite.config.js (FIXED SYNTAX ERROR HERE)
(
echo import { defineConfig } from 'vite'
echo import react from '@vitejs/plugin-react'
echo export default defineConfig({
echo   plugins: [react^()],
echo   server: { open: true },
echo   esbuild: {
echo     loader: 'jsx',
echo     include: /src\/.*\.jsx?$/,
echo     exclude: []
echo   },
echo   optimizeDeps: {
echo     esbuildOptions: {
echo       loader: {
echo         '.js': 'jsx',
echo       },
echo     },
echo   },
echo }^)
) > vite.config.js

:: Create index.html
(
echo ^<!doctype html^>
echo ^<html lang="en"^>
echo   ^<head^>
echo     ^<meta charset="UTF-8" /^>
echo     ^<meta name="viewport" content="width=device-width, initial-scale=1.0" /^>
echo     ^<title^>ET Omniverse^</title^>
echo     ^<script src="https://cdn.tailwindcss.com"^>^</script^>
echo   ^</head^>
echo   ^<body^>
echo     ^<div id="root"^>^</div^>
echo     ^<script type="module" src="/src/main.jsx"^>^</script^>
echo   ^</body^>
echo ^</html^>
) > index.html

:: --- STEP 3: SOURCE CODE PREP ---
echo [3/6] Preparing Source Code...

if not exist "src" mkdir "src"

:: Create Entry Point (main.jsx)
(
echo import React from 'react'
echo import { createRoot } from 'react-dom/client'
echo.
echo // Polyfill globals
echo window.React = React;
echo window.ReactDOM = { createRoot };
echo.
echo // Load user script
echo import^('./UserScript.jsx'^);
) > src\main.jsx

:: Copy User Script
echo Copying %SOURCE_FILE%...
copy /Y "..\ET_Periodic_Omniverse.jsx" "src\UserScript.jsx" >nul
if %errorlevel% neq 0 (
    echo [ERROR] Failed to copy source file.
    exit /b 1
)

:: --- STEP 4: DEPENDENCY INSTALLATION ---
echo [4/6] Installing Dependencies (This may take a minute)...
call npm install
if %errorlevel% neq 0 (
    echo.
    echo [ERROR] 'npm install' failed.
    echo Please check your internet connection.
    exit /b 1
)

:: --- STEP 5: LAUNCH ---
echo [5/6] Launching Server...
echo.
echo ========================================================
echo  ET OMNIVERSE IS STARTING...
echo  Your browser should open automatically.
echo  Keep this window open to maintain the server.
echo ========================================================
echo.

call npm run dev

if %errorlevel% neq 0 (
    echo.
    echo [ERROR] Application crashed or Vite failed to start.
    exit /b 1
)

:: --- STEP 6: FINISHED ---
echo.
echo Server stopped.
exit /b 0